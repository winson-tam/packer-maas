#!/usr/bin/env python3
# curtin-hooks - Curtin installation hooks for Proxmox VE

import os
import shutil
from curtin.commands.curthooks import builtin_curthooks
from curtin.config import load_command_config
from curtin.util import load_command_environment

def configure_proxmox(config):
    """Amend the curtin config to install Proxmox VE packages."""
    late_commands = config.get('late_commands', {})
    late_commands['install_proxmox'] = (
        'curtin in-target --target=/target '
        '-- apt-get update && '
        'apt-get install -y proxmox-ve postfix open-iscsi'
    )
    config['late_commands'] = late_commands
    return config

def cleanup():
    """Remove curtin-hooks so it's as if we were never here."""
    curtin_dir = os.path.dirname(__file__)
    shutil.rmtree(curtin_dir)

def main():
    state = load_command_environment()
    config = load_command_config(None, state)
    target = state['target']

    config = configure_proxmox(config)
    builtin_curthooks(config, target, state)
    cleanup()

if __name__ == "__main__":
    main()
